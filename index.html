<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="style.css" />

    <script src="https://unpkg.com/tesseract.js@2.1.4/dist/tesseract.min.js"></script>

    <script type="module">
      const { createWorker } = Tesseract;

      var status = document.querySelector(".loading");
      var progress = document.querySelector(".progress");

      const worker = createWorker({
        logger: (m) => {
          console.log(m);
          if (m.status === "recognizing text") {
            status.innerHTML = "ë¶„ì„ ì¤‘...";
            progress.innerHTML = Math.floor(m.progress * 100) + "%";

            if (m.progress === 1) {
              status.innerHTML = "ë¶„ì„ ì™„ë£Œâœ¨";
              progress.innerHTML = "";
            }
          } else {
            status.innerHTML = "ì´ë¯¸ì§€ ì „ì†¡ ì¤‘, ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!!";
          }
        },
      });

      /*ê°œì¸ì •ë³´ ì¶”ì¶œ*/
      const findInfomation = (data) => {
        var phone = /\d{3}-\d{4}-\d{4}/;
        var id =
          /\d{2}([0]\d|[1][0-2])([0][1-9]|[1-2]\d|[3][0-1])[-]*[1-4]\d{6}/;

        var result_phone = [];
        var result_id = [];

        data.words.map((word) => {
          if (word.text.match(phone)) {
            result_phone.push(word);
          }

          if (word.text.match(id)) {
            result_id.push(word);
          }
        });

        if (result_phone) {
          console.log("í° ë²ˆí˜¸ : ", result_phone);
          result_phone.map((res) => {
            console.log("ì¢Œí‘œëŠ” : ", res.line.bbox);
            var { x0, y0, x1, y1 } = res.line.bbox;
            draw(x0, y0, x1, y1);
          });
        }

        if (result_id) {
          console.log("ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ :", result_id);
          result_id.map((res) => {
            console.log("ì¢Œí‘œëŠ” : ", res.line.bbox);
            var { x0, y0, x1, y1 } = res.line.bbox;
            draw(x0, y0, x1, y1);
          });
        }
      };

      /*ocr ê²°ê³¼ ì½˜ì†” ì¶œë ¥*/
      function result(res) {
        console.log("result was:", res);

        res.words.forEach(function (w) {
          var b = w.bbox;
        });

        findInfomation(res);
      }

      /* í…Œì„œë™elmíŠ¸ ì‹¤í–‰ */
      const recognize = async (file) => {
        const {
          data: { text },
        } = await Tesseract.recognize(file, "kor", {
          corePath:
            "https://unpkg.com/tesseract.js-core@v2.0.0/tesseract-core.wasm.js",
          logger: (m) => console.log(m),
        });
        console.log(text);
        result = text;
      };

      const elm = document.getElementById("ex_filename");

      /*í…Œì„œë ‰íŠ¸ ì„œë²„ë¡œ íŒŒì¼ ë³´ë‚´ê¸°*/
      const sendFile = async () => {
        console.log("ì„±ê³µ", elm.files[0]);
        await worker.load();
        await worker.loadLanguage("kor");
        await worker.initialize("kor");
        const { data } = await worker.recognize(elm.files[0]);
        await worker.terminate();
        result(data);
      };

      var sizeModified = false;
      var B = 1;

      /*ìº”ë²„ìŠ¤ì— ì‚¬ì§„ ë³´ì—¬ì£¼ê¸°*/
      function readInputFile(e) {
        var file = e.target.files;

        var reader = new FileReader();
        //var img = new Image();
        var img = document.createElement("img");

        var w_width = window.innerWidth;
        var w_height = window.innerHeight;

        var WIDTH = 55;
        var HEIGHT = 55;

        reader.onload = function (e) {
          img.onload = function () {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            WIDTH = img.width;
            HEIGHT = img.height;

            if (HEIGHT > w_height * 0.3) {
              console.log("ì„¸ë¡œê°€ ì»¤ìš”");

              B = (w_height * 0.3) / HEIGHT;

              WIDTH = WIDTH * B;
              HEIGHT = HEIGHT * B;
              console.log(B, WIDTH, HEIGHT);
            }

            if (WIDTH > w_width * 0.8) {
              console.log("ê°€ë¡œê°€ ì»¤ìš”");
              B = (w_width * 0.8) / WIDTH;
              WIDTH = WIDTH * B;
              HEIGHT = HEIGHT * B;
              console.log(B, WIDTH, HEIGHT);
            }

            // else {
            //   WIDTH = img.width;
            //   HEIGHT = img.height;
            // }

            // WIDTH = w_width * 0.8;
            // HEIGHT = w_height * 0.8;
            // sizeModified = 0.8;

            canvas.width = WIDTH;
            canvas.height = HEIGHT;
            ctx.drawImage(img, 0, 0, WIDTH, HEIGHT);
          };

          img.src = e.target.result;
        };

        reader.readAsDataURL(file[0]);
      }

      /*ë§ˆìŠ¤í‚¹ ê·¸ë¦¬ê¸°*/
      function draw(x0, y0, x1, y1) {
        var start_x = x0;
        var start_y = y0;
        var width = x1 - x0;
        var height = y1 - y0;

        ctx.fillStyle = "rgb(0,0,0,1)";

        ctx.fillRect(start_x * B, start_y * B, width * B, height * B);
      }

      /*ìˆ˜ì •í•œ ì‚¬ì§„ ë¡œì»¬ì— ì €ì¥í•˜ëŠ” í•¨ìˆ˜*/
      function Save(event) {
        console.log("ì €ì¥");
        const image = canvas.toDataURL("image/jpeg");
        event.target.href = image; // ìˆ˜ì •ëœ ìº”ë²„ìŠ¤ ì‚¬ì§„ ì €ì¥
        event.target.download = "PaintIMG[ğŸ¨]";
      }

      const canvas = document.querySelector("#jsCanvas");
      const ctx = canvas.getContext("2d");
      const startBtn = document.querySelector(".start-btn");
      const realInput = document.querySelector(".upload-hidden");
      var saveBtn = document.querySelector("#save");

      realInput.addEventListener("change", readInputFile);
      startBtn.addEventListener("click", sendFile);

      saveBtn.addEventListener("click", Save);
    </script>
  </head>

  <body>
    <img src="./assets/BGcircle.svg" />
    <h1>ì‚¬ì§„ ì† ê°œì¸ ì •ë³´ ë§ˆìŠ¤í‚¹</h1>

    <label for="ex_filename" class="select-btn">ì´ë¯¸ì§€ ì„ íƒ</label>
    <div class="filebox">
      <input class="upload-name hidden" value="íŒŒì¼ì„ íƒ" disabled="disabled" />

      <input
        type="file"
        class="upload-hidden"
        id="ex_filename"
        accept="img/*"
        required
      />
    </div>

    <div>
      <p class="loading"></p>
      <p class="progress"></p>
    </div>

    <canvas id="jsCanvas" class="canvas" style="margin: 0 10px 0 10px"></canvas>

    <div class="btn-container">
      <a id="save">ì €ì¥</a>
      <div class="start-btn">ì‹œì‘</div>
    </div>

    <script src="./InputBtn.js"></script>
  </body>
</html>
